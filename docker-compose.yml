services:
  ollama:
    container_name: ollama
    image: ollama/ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["1"]
              capabilities: [gpu]
    networks:
      - personal-ai
    ports:
      - 11434:11434
    restart: always
    volumes:
      - ./ollama/models:/root/.ollama/models

  ollama-api:
    container_name: ollama-api
    depends_on:
      - ollama
    build:
      context: ./ollama
      args:
        - http_proxy=http://192.168.2.3:6665
        - https_proxy=http://192.168.2.3:6665
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["1"]
              capabilities: [gpu]
    networks:
      - personal-ai
    ports:
      - 5175:80
    restart: always
    secrets:
      - mistral_api_key
    volumes:
      - ./ollama:/ollama

  tts:
    container_name: tts
    build:
      context: ./tts
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["1"]
              capabilities: [gpu]
    networks:
      - personal-ai
    ports:
      - 5176:80
    restart: always
    volumes:
      - ./tts:/tts
      - ./tts/models:/root/.local/share/tts/

  argos-translate:
    container_name: argos-translate
    build:
      context: ./argos-translate
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["1"]
              capabilities: [gpu]
    environment:
      - ARGOS_LANGUAGES=en,fr,zh,es
    networks:
      - personal-ai
    ports:
      - 5177:80
    volumes:
      - ./argos-translate:/argos-translate
      - ./argos-translate/local:/home/libretranslate/.local
      - ./argos-translate/db:/app/db
    restart: always

  comfy:
    container_name: comfy
    build:
      context: ./comfy
      args:
        - http_proxy=http://192.168.2.3:6665
        - https_proxy=http://192.168.2.3:6665
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]
              capabilities: [gpu]
    networks:
      - personal-ai
    ports:
      - 8188:8188
    restart: always
    volumes:
      - ~/app/models/:/ComfyUI/models/
      - ./comfy/output:/ComfyUI/output
      - ./comfy/custom_nodes:/ComfyUI/custom_nodes

  app:
    container_name: app
    build:
      context: ./app
    depends_on:
      - argos-translate
      - comfy
      - ollama-api
      - tts
    networks:
      - personal-ai
    ports:
      - 9000:9000
    restart: always
    volumes:
      - ./app:/app

  nginx:
    container_name: nginx
    depends_on:
      - app
    image: nginx:stable
    networks:
      - personal-ai
    ports:
      - 8920:443
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certificates:/etc/certificates

secrets:
  mistral_api_key:
    file: ./secrets/mistral_api_key.txt

networks:
  personal-ai:
